{% extends "base_generic.html" %}

{% block title %}
<title>Meu Carrinho</title>
{% endblock %}

{% block content %}
{% load staticfiles %}
<!-- Main jumbotron for a primary marketing message or call to action -->
      <div class="jumbotron">
        <div class="container">
          <h1>Meu Carrinho </h1>
        </div>
      </div>
<div class="container">
<table id="tabela_produtos" class="" style="width:100%">

        <tbody>
            {% for produto in produtos %}
            <tr style="border-bottom: 1px solid black;" class="produto">
                <td>
                  <img style="height:300px; width:auto; margin: 20px;" class="card-img-top" src={{ produto.images.0.url }} alt="Imagem de eletrodomésticos" />
                </td>
                <td>
                  <h4>{{produto.name|safe}}</h4>
                  <br>
                  {{ produto.description|safe }}
                  <br><br>
                  <strong>R$<span class="valor_unitario" value="{{ produto.value|safe }}">{{ produto.value|safe }}</span></strong>
                  <input hidden value="slafj" class="lksdfj"> <br/>
                  <form action="/remove_carrinho/" method="POST">
                    <input hidden value="{{produto.id}}" name="id_produto" id="id_produto">
                    <input hidden value="{{produto.quantityInStock}}" class="quantidade_estoque">
                    <button type="submit" class="btn btn-danger">
                        Remover
                    </button>
                  </form>
                </td>

                <td>
                  <form style="margin: 15px;" action="/meu_carrinho/">
                    Quantidade:
                    <input type="number" id="{{produto.id}}" name="quantity" class="unidades" min="0" max="100" step="1" value="1"
                                                          onkeypress="atualiza_quantidade(this)" onclick="atualiza_quantidade(this)">
                  </form>
                </td>
                <td>
                  <strong>Valor total</strong>
                  <br/>
                  R$<span class="valor_total">2000</span>
                </td>
            </tr>
            {% endfor%}
        </tbody>
    </table>
 </div>
 <div class="container">
   <p style="text-align: right;" >Valor Frete: R$<span id="valor_frete">{{valor_frete.valor|safe}}</span></p>
 </div>
<div class="container">
  <b style="text-align: right;" ><h3>Valor Total: R$<span id="valor_total_pedido"></span></h3></b>
</div>


<div class="container">
</br>
  <form action="/pagamento/" method="POST">
    <input hidden value='' name="valor_total_form" id="valor_total_form">
     <button type="submit" style="float:right" class="btn btn-warning">
         <span class="fa fa-shopping-cart"></span> Efetuar pagamento
     </button>
     <br/>
  </form>
</div>
{% endblock %}

{% block scripts %}

<script type="text/javascript">
  $(document).ready(function() {
    $('#tabela_produtos').DataTable();
    atualiza_valor();
    atualiza_valor_total();
} );
  atualiza_valor();
  atualiza_valor_total();

  // Atualiza quantidade (requisição AJAX para API de produtos)
  function atualiza_quantidade(element) {
    quantidade = $('.produto').length;
    qnt_estoque = $('.quantidade_estoque');
    unidades = $('.unidades');
    for(i = 0; i < quantidade; i++) {
      if (parseInt(qnt_estoque[i].value) < parseInt(unidades[i].value)) {
        unidades[i].value = qnt_estoque[i].value
        alert("Limite Excedido")
      }
    }
    atualiza_banco(element);
    atualiza_valor();
  }

  function atualiza_banco(element) {
    // Envia atualização para p BD
    $.ajax({
        url: '/altera_quantidade/',
        method: 'POST',
        data: {
          'id_produto': element.id,
          'quantidade': element.value,
        },
        dataType: 'json',
        success: function (data) {
          console.log("Quantidade atualizada no BD")
        }
      });
  }

  // Atualiza os valores totais dos produtos individualmente
  function atualiza_valor() {
    quantidade = $('.produto').length;
    valor = $('.valor_unitario');
    unidades = $('.unidades');
    valor_total = $('.valor_total')
    for(i = 0; i < quantidade; i++) {
        valor_total_produto = parseFloat(valor[i].innerHTML)*unidades[i].value;
        valor_total[i].textContent = valor_total_produto.toFixed(2)
    }
    atualiza_valor_total();
  }

  function atualiza_valor_total () {
    valor_total = $('.valor_total');
    valor_final = 0;
    for (i = 0; i < valor_total.length; i++) {
      valor_final = valor_final + parseFloat(valor_total[i].innerHTML);
    }
    valor_final = valor_final + parseFloat($('#valor_frete').html());
    $('#valor_total_pedido').html(valor_final.toFixed(2));
    $('#valor_total_form').val(valor_final);

    return;
  }

</script>

{% endblock %}
